import { getCollection } from 'astro:content';
import type { Job } from './types';

// Re-export the Job type for backward compatibility
export type { Job } from './types';

export interface Era {
	id: string;
	name: string;
	years: string;
	description: string;
	context: string;
	primarySources: string[];
}

export const eras: Era[] = [
	{
		id: "agrarian",
		name: "Agrarian / Colonial Era",
		years: "1600s–1820",
		description: "Pre-industrial farming in rural America",
		context: "Daily life centered on planting, harvesting, household labor, and local community responsibilities",
		primarySources: ["Crèvecœur's Letters from an American Farmer", "John & Abigail Adams letters"]
	},
	{
		id: "market-revolution",
		name: "Market Revolution Era",
		years: "1820–1880",
		description: "Transition from artisan to factory work, rise of wage labor, and early industrialization",
		context: "The Market Revolution transforms work: artisans become wage workers, factories replace workshops, and the distinction between free and slave labor intensifies",
		primarySources: ["Lowell Mill Girls letters and writings", "Frederick Douglass's narratives on labor", "Alexis de Tocqueville's Democracy in America", "Early labor newspapers and organizing documents"]
	},
	{
		id: "industrial",
		name: "Industrial Era",
		years: "1880–1970",
		description: "Rapid industrialization, urban factories, meatpacking, labor unrest, and the rise of automation",
		context: "Building on the First Industrial Revolution's foundation, the Second Industrial Revolution (1880-1914) brings steel, electricity, and mass production. Labor movements emerge: Haymarket Strike (1886), Homestead Strike (1892), Pullman Strike (1894). The mature industrial era (1914-1970) sees automation, assembly lines, and early computing transform manufacturing, while unions gain power and workers adapt to new technologies.",
		primarySources: ["Upton Sinclair's The Jungle", "1906 U.S. House Report on Chicago Stockyards", "Oral histories of Texas oil technicians", "Bureau of Labor Statistics bulletins on automation"]
	},
	{
		id: "post-industrial",
		name: "Post-Industrial Era",
		years: "1970–2000",
		description: "Transition to service economy, rise of computing, and early digital technologies",
		context: "Workers transitioning from manufacturing to service and technology sectors. The rise of personal computing and software development transforms work",
		primarySources: ["Historical studies of women in tech", "Hidden Figures", "Bureau of Labor Statistics on service sector growth"]
	},
	{
		id: "digital",
		name: "Digital Era",
		years: "2000–present",
		description: "Robotics, AI, and automation replacing human work",
		context: "The rise of cloud computing, social media platforms, and mobile technology transforms how people work and connect. Gig economy platforms (Uber, Airbnb, TaskRabbit) create new forms of precarious employment. AI and machine learning automate knowledge work, while social media creates new job categories (influencers, content creators, community managers) and transforms marketing and communication. Remote work becomes mainstream, enabled by cloud infrastructure and collaboration tools. Automation accelerates across industries, from manufacturing to service sectors, raising questions about the future of work and economic inequality.",
		primarySources: ["H. David Autor's 'Why Are There Still So Many Jobs?'", "Norbert Wiener's The Human Use of Human Beings", "Studies on gig economy and platform work", "Research on AI and automation impacts"]
	}
];

// Get all jobs from content collection
export async function getAllJobs(): Promise<Job[]> {
	const jobEntries = await getCollection('jobs' as any);
	return jobEntries.map((entry: any) => ({
		id: entry.data.id,
		title: entry.data.title,
		company: entry.data.company,
		location: entry.data.location,
		type: entry.data.type,
		salary: entry.data.salary,
		description: entry.body.trim(),
		requirements: entry.data.requirements,
		postedDate: entry.data.postedDate,
		era: entry.data.era,
		filters: entry.data.filters,
	}));
}

function parseDate(dateStr: string): Date {
	// Handle formats like "March 15, 1785", "January 15, 2020", etc.
	const months: Record<string, number> = {
		'january': 0, 'jan': 0,
		'february': 1, 'feb': 1,
		'march': 2, 'mar': 2,
		'april': 3, 'apr': 3,
		'may': 4,
		'june': 5, 'jun': 5,
		'july': 6, 'jul': 6,
		'august': 7, 'aug': 7,
		'september': 8, 'sep': 8, 'sept': 8,
		'october': 9, 'oct': 9,
		'november': 10, 'nov': 10,
		'december': 11, 'dec': 11
	};
	
	// Clean the date string
	const cleaned = dateStr.trim().toLowerCase().replace(/,/g, '');
	const parts = cleaned.split(/\s+/);
	
	if (parts.length >= 3) {
		const monthName = parts[0];
		const day = parseInt(parts[1]) || 1;
		const year = parseInt(parts[2]) || 1800;
		const month = months[monthName] ?? 0;
		
		// Create date with year, month, day
		return new Date(year, month, day);
	}
	
	// Try to parse as ISO date or other formats
	const parsed = Date.parse(dateStr);
	if (!isNaN(parsed)) {
		return new Date(parsed);
	}
	
	// Fallback: return a date based on era if we can't parse
	console.warn(`Could not parse date: ${dateStr}`);
	return new Date(1800, 0, 1);
}

export async function getJobsByEra(eraId: string): Promise<Job[]> {
	const allJobs = await getAllJobs();
	const eraJobs = allJobs.filter(job => job.era === eraId);
	// Sort chronologically by postedDate - most recent first
	return eraJobs.sort((a, b) => {
		const dateA = parseDate(a.postedDate);
		const dateB = parseDate(b.postedDate);
		return dateB.getTime() - dateA.getTime(); // Most recent first
	});
}

export function getEraById(eraId: string): Era | undefined {
	return eras.find(era => era.id === eraId);
}

// For backward compatibility, export jobs as a getter
export async function getJobs(): Promise<Job[]> {
	return getAllJobs();
}
